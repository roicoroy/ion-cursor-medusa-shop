<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/returns"></ion-back-button>
    </ion-buttons>
    <ion-title>Create Return</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <form [formGroup]="returnForm" (ngSubmit)="submitReturn()">
    <div class="ion-padding">
      <!-- Loading State -->
      <div *ngIf="loading$ | async" class="ion-text-center ion-padding">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Loading...</p>
      </div>

      <!-- Error State -->
      <div *ngIf="error$ | async as error" class="ion-text-center ion-padding">
        <ion-icon name="alert-circle" color="danger" size="large"></ion-icon>
        <p>{{ error }}</p>
      </div>

      <!-- Order Items -->
      <div *ngIf="!(loading$ | async) && !(error$ | async) && (order$ | async) as order">
        <ion-card>
          <ion-card-header>
            <ion-card-title>Select Items to Return</ion-card-title>
            <p>Order #{{ order.display_id }}</p>
          </ion-card-header>
          <ion-card-content>
            <ion-list>
              <ion-item *ngFor="let item of order.items" class="order-item">
                <ion-checkbox 
                  slot="start"
                                     [checked]="selectedItems[item.id].selected"
                  (ionChange)="toggleItemSelection(item.id)">
                </ion-checkbox>
                
                <ion-thumbnail slot="start">
                  <ion-img [src]="item.thumbnail || 'assets/images/placeholder-product.jpg'"
                           (ionError)="$event.target.src = 'assets/images/placeholder-product.jpg'">
                  </ion-img>
                </ion-thumbnail>
                
                <ion-label>
                  <h3>{{ item.title }}</h3>
                  <p>{{ item.variant_title }}</p>
                  <p><strong>Price:</strong> {{ item.unit_price | medusaCurrency }}</p>
                  <p><strong>Original Quantity:</strong> {{ item.quantity }}</p>
                </ion-label>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>

        <!-- Selected Items Details -->
        <ion-card *ngIf="getSelectedItemsCount() > 0">
          <ion-card-header>
            <ion-card-title>Return Details</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div *ngFor="let item of order.items">
              <div *ngIf="selectedItems[item.id]?.selected" class="return-item-details">
                <h4>{{ item.title }}</h4>
                
                <ion-item>
                  <ion-label position="stacked">Return Quantity</ion-label>
                  <ion-select 
                                         [value]="selectedItems[item.id].quantity"
                    (ionChange)="updateItemQuantity(item.id, $event)"
                    placeholder="Select quantity">
                    <ion-select-option *ngFor="let qty of [1,2,3,4,5,6,7,8,9,10]" 
                                      [value]="qty" 
                                      [disabled]="qty > item.quantity">
                      {{ qty }} (max: {{ item.quantity }})
                    </ion-select-option>
                  </ion-select>
                </ion-item>

                <ion-item>
                  <ion-label position="stacked">Return Reason</ion-label>
                  <ion-select 
                                         [value]="selectedItems[item.id].reason_id"
                    (ionChange)="updateItemReason(item.id, $event)"
                    placeholder="Select reason">
                    <ion-select-option *ngFor="let reason of returnReasons$ | async" 
                                      [value]="reason.id">
                      {{ reason.label }}
                    </ion-select-option>
                  </ion-select>
                </ion-item>

                <ion-item>
                  <ion-label position="stacked">Additional Notes</ion-label>
                  <ion-textarea 
                                         [value]="selectedItems[item.id].note"
                    (ionInput)="updateItemNote(item.id, $event)"
                    placeholder="Optional notes about this item"
                    rows="2">
                  </ion-textarea>
                </ion-item>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Return Shipping -->
        <ion-card formGroupName="return_shipping">
          <ion-card-header>
            <ion-card-title>Return Shipping</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-item>
              <ion-label position="stacked">Shipping Option *</ion-label>
              <ion-select formControlName="option_id" placeholder="Select shipping option">
                <ion-select-option value="standard">Standard Return</ion-select-option>
                <ion-select-option value="express">Express Return</ion-select-option>
              </ion-select>
            </ion-item>
          </ion-card-content>
        </ion-card>

        <!-- Additional Options -->
        <ion-card formGroupName="metadata">
          <ion-card-header>
            <ion-card-title>Additional Information</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-item>
              <ion-label position="stacked">General Notes</ion-label>
              <ion-textarea 
                formControlName="note"
                placeholder="Any additional information about your return"
                rows="3">
              </ion-textarea>
            </ion-item>
            
            <ion-item>
              <ion-checkbox formControlName="no_notification" slot="start"></ion-checkbox>
              <ion-label>Don't send me notifications about this return</ion-label>
            </ion-item>
          </ion-card-content>
        </ion-card>

        <!-- Summary -->
        <ion-card *ngIf="getSelectedItemsCount() > 0">
          <ion-card-header>
            <ion-card-title>Return Summary</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <p><strong>Items to return:</strong> {{ getSelectedItemsCount() }}</p>
            <p><strong>Estimated refund:</strong> {{ getTotalRefundAmount(order) | medusaCurrency }}</p>
          </ion-card-content>
        </ion-card>
      </div>
    </div>
  </form>
</ion-content>

<ion-footer>
  <ion-toolbar>
    <ion-button 
      expand="block" 
      (click)="submitReturn()" 
      [disabled]="!isFormValid() || (loading$ | async)"
      class="submit-button">
      <ion-spinner *ngIf="loading$ | async" name="crescent"></ion-spinner>
      {{ (loading$ | async) ? 'Creating Return...' : 'Submit Return' }}
    </ion-button>
  </ion-toolbar>
</ion-footer> 